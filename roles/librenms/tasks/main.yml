---
# tasks file for hosts-build-librenms
- name: update and upgrade apt packages
  become: true
  apt:
    upgrade: yes
    update_cache: yes
    cache_valid_time: 86400 #24 Hours
- name: install prereqs
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - fping
    - composer
    - curl
    - git
    - graphviz
    - imagemagick
    - mariadb-client
    - mariadb-server
    - mtr-tiny
    - nginx-full
    - nmap
    - php7.3-cli
    - php7.3-curl
    - php7.3-fpm
    - php7.3-gd
    - php7.3-json
    - php7.3-mbstring
    - php7.3-mysql
    - php7.3-snmp
    - php-net-ipv4
    - php-net-ipv6
    - php-pear
    - python-mysqldb
    - rrdtool
    - snmp
    - snmpd
    - whois
    - php7.3-xml
    - php7.3-zip
    - python-memcache
    - python-mysqldb

- name: Create DB
  mysql_db:
    name: librenms
    state: present
  notify: restart_mysql

- name: Create DB User
  mysql_user:
    name: librenms
    host: localhost
    priv: librenms.*:ALL
    password: "{{ librenms_pass }}"
  notify: restart_mysql

- name: Enable mysql
  service:
    name: mysql
    enabled: yes

- name: Add group
  group:
    name: librenms
    system: True
    state: present

- name: Add user
  user:
    name: librenms
    group: www-data
    comment: 'Librenms'
    system: True
    state: present

- name: Make sure required directories exist
  file:
    dest: '{{ item }}'
    state: 'directory'
    owner: '{{ librenms__user }}'
    group: '{{ librenms__group }}'
    mode: '0750'
  with_items:
    - '{{ librenms__data_path }}'
    - '{{ librenms__rrd_dir }}'
    - '{{ librenms__log_dir }}'
